# =============================================================================
# CI/CD Pipeline: Build Windows Desktop App & Deploy Web to GitHub Pages
# =============================================================================
# This workflow handles two parallel jobs:
#   1. Building a Windows .exe release and uploading it as an artifact.
#   2. Building the Flutter Web app and deploying it to GitHub Pages.
# =============================================================================

name: Build & Deploy

# -----------------------------------------------------------------------------
# Triggers
# -----------------------------------------------------------------------------
on:
  # Allow manual triggering from the GitHub Actions UI
  workflow_dispatch:

  # Automatically run on pushes to the main branch
  push:
    branches:
      - main

# =============================================================================
# Job 1: Build Windows Desktop Application
# =============================================================================
jobs:
  build-windows:
    name: ðŸ–¥ï¸ Build Windows Desktop App
    runs-on: windows-latest

    steps:
      # Step 1: Checkout the repository code
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Flutter SDK (stable channel)
      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      # Step 3: Enable Windows desktop support
      - name: âš™ï¸ Enable Windows Desktop
        run: flutter config --enable-windows-desktop

      # Step 4: Create .env file from GitHub Secrets
      #         The .env is listed as an asset in pubspec.yaml but is gitignored.
      #         We populate it with secrets so flutter_dotenv can read them at runtime.
      - name: ðŸ“„ Create .env file
        run: |
          echo SUPABASE_URL=${{ secrets.SUPABASE_URL }} > .env
          echo SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} >> .env
        shell: cmd

      # Step 5: Install project dependencies
      - name: ðŸ“¦ Install dependencies
        run: flutter pub get

      # Step 5.5: Patch printing plugin to disable text anti-aliasing (for thermal printers)
      #           pdfium renders anti-aliased text by default, which gets dithered into
      #           fuzzy dots on 1-bit thermal printers. This adds FPDF_RENDER_NO_SMOOTHTEXT.
      - name: ðŸ”§ Patch printing plugin for thermal printer
        run: |
          $pubCache = "$env:LOCALAPPDATA\Pub\Cache\hosted\pub.dev"
          $printingDir = Get-ChildItem -Path $pubCache -Directory -Filter "printing-*" | Select-Object -First 1
          $file = Join-Path $printingDir.FullName "windows\print_job.cpp"
          if (Test-Path $file) {
            (Get-Content $file) -replace 'FPDF_ANNOT \| FPDF_PRINTING\)', 'FPDF_ANNOT | FPDF_PRINTING | FPDF_RENDER_NO_SMOOTHTEXT)' | Set-Content $file
            Write-Host "Patched $file with FPDF_RENDER_NO_SMOOTHTEXT"
          } else {
            Write-Host "WARNING: print_job.cpp not found at $file"
          }
        shell: pwsh

      # Step 6: Build the Windows release binary
      #         Passes Supabase credentials via --dart-define from GitHub Secrets
      - name: ðŸ”¨ Build Windows Release
        run: >
          flutter build windows --release
          --dart-define=SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}

      # Step 7: Zip the release output folder for upload
      - name: ðŸ“¦ Zip Release Build
        run: Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath "Windows-Release-Build.zip"
        shell: pwsh

      # Step 8: Upload the zipped build as a GitHub Actions artifact
      - name: â¬†ï¸ Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Release-Build
          path: Windows-Release-Build.zip

  # =============================================================================
  # Job 2: Build & Deploy Flutter Web to GitHub Pages
  # =============================================================================
  deploy-web:
    name: ðŸŒ Build & Deploy Web to GitHub Pages
    runs-on: ubuntu-latest

    # Required permissions to push to the gh-pages branch
    permissions:
      contents: write

    steps:
      # Step 1: Checkout the repository code
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Flutter SDK (stable channel)
      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      # Step 3: Create .env file from GitHub Secrets
      #         The .env is listed as an asset in pubspec.yaml but is gitignored.
      #         We populate it with secrets so flutter_dotenv can read them at runtime.
      - name: ðŸ“„ Create .env file
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > .env
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> .env

      # Step 4: Install project dependencies
      - name: ðŸ“¦ Install dependencies
        run: flutter pub get

      # Step 5: Build the Flutter Web release
      #         --base-href must match your GitHub Pages repo name
      #         Replace <YOUR_REPO_NAME> with your actual repository name if different
      #         Passes Supabase credentials via --dart-define from GitHub Secrets
      - name: ðŸ”¨ Build Web Release
        run: >
          flutter build web --release
          --base-href "/arcade-cashier/"
          --dart-define=SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}

      # Step 6: Add .nojekyll file to prevent GitHub Pages from processing
      #         files with underscores (essential for Flutter web builds)
      - name: ðŸ“„ Add .nojekyll file
        run: touch build/web/.nojekyll

      # Step 6.5: Copy index.html to 404.html for SPA deep-link support
      #           GitHub Pages serves 404.html for any unknown path, which
      #           boots the Flutter app and lets go_router handle the route.
      - name: ðŸ”€ Create 404.html for SPA routing
        run: cp build/web/index.html build/web/404.html

      # Step 7: Deploy the build/web directory to the gh-pages branch
      - name: ðŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/web
